import { useEffect, useRef, useState, useCallback } from 'react';
import { gsap } from 'gsap';

const STORAGE_KEY = 'studio-spath-intro-seen';

const IntroGateNew = ({ onComplete }) => {
  const containerRef = useRef(null);
  const outlineRef = useRef(null);
  const fillRef = useRef(null);
  const maskRef = useRef(null);
  const textRef = useRef(null);
  const timelineRef = useRef(null);
  const [isVisible, setIsVisible] = useState(true);

  const handleComplete = useCallback(() => {
    setIsVisible(false);
    markAsSeenToday();
    if (onComplete) {
      setTimeout(() => {
        onComplete();
      }, 50);
    }
  }, [onComplete]);

  useEffect(() => {
    if (!isVisible) return;

    const container = containerRef.current;
    const outline = outlineRef.current;
    const fill = fillRef.current;
    const mask = maskRef.current;
    const text = textRef.current;

    if (!container || !outline || !fill || !mask || !text) return;

    // Set initial states
    gsap.set(container, { opacity: 1 });
    
    // Outline: start drawing immediately (avoid initial blank screen)
    const pathLength = outline.getTotalLength();
    gsap.set(outline, {
      strokeDasharray: pathLength,
      strokeDashoffset: pathLength,
      opacity: 1,
    });
    
    // Fill: ready to be revealed by mask (mask controls visibility)
    gsap.set(fill, { opacity: 1 });
    gsap.set(mask, { attr: { y: 912 } });
    
    // Text: invisible, ready to appear
    gsap.set(text, { opacity: 0, y: 4 });

    // Create timeline with architectural pacing
    const tl = gsap.timeline({
      onComplete: handleComplete,
      defaults: { ease: 'power1.inOut' }
    });

    // Phase 1: Outline draw (calm + immediate)
    tl.to(outline, {
      strokeDashoffset: 0,
      duration: 3.2,
    }, 0);

    // Phase 2: Fill reveal (starts earlier so we never feel \"empty\")
    tl.to(mask, {
      attr: { y: 0 },
      duration: 1.4,
      ease: 'power2.inOut',
    }, 2.0)
    .to(outline, {
      opacity: 0,
      duration: 0.8,
      ease: 'power2.out',
    }, 2.2); // Outline fades as fill appears

    // Phase 3: Text appearance (earlier + gentle)
    tl.to(text, {
      opacity: 1,
      y: 0,
      duration: 0.9,
      ease: 'power2.out',
    }, 2.4);

    // Phase 4: Hold and transition
    tl.to({}, { duration: 0.7 })
    .to(container, {
      opacity: 0,
      duration: 0.6,
      ease: 'power2.in',
    }, '+=0');

    timelineRef.current = tl;

    // Handle skip (scroll or click)
    const handleSkip = () => {
      if (timelineRef.current) {
        timelineRef.current.kill();
      }
      handleComplete();
    };

    if (container) {
      container.addEventListener('click', handleSkip, { once: true });
      container.addEventListener('wheel', handleSkip, { once: true, passive: true });
      container.addEventListener('touchstart', handleSkip, { once: true, passive: true });
    }

    return () => {
      if (timelineRef.current) {
        timelineRef.current.kill();
      }
      if (container) {
        container.removeEventListener('click', handleSkip);
        container.removeEventListener('wheel', handleSkip);
        container.removeEventListener('touchstart', handleSkip);
      }
    };
  }, [isVisible, handleComplete]);

  if (!isVisible) return null;

  return (
    <div
      ref={containerRef}
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        width: '100%',
        height: '100%',
        background: '#ffffff',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        flexDirection: 'column',
        overflow: 'hidden',
        zIndex: 9999,
        cursor: 'pointer',
      }}
    >
      {/* SVG Container */}
      <div style={{ width: '220px', position: 'relative' }}>
        <svg
          viewBox="0 0 1024 912"
          xmlns="http://www.w3.org/2000/svg"
          style={{ width: '100%', height: 'auto' }}
        >
          <defs>
            <mask id="fillMask">
              <rect 
                ref={maskRef} 
                x="0" 
                y="912" 
                width="1024" 
                height="912" 
                fill="white" 
              />
            </mask>
          </defs>

          {/* Filled Logo (revealed by mask) */}
          <path
            ref={fillRef}
            d="M470.999939,848.324341   C359.668121,848.321960 248.836304,848.344116 138.004547,848.271423   C128.692078,848.265320 119.381805,847.552917 110.066765,847.315491   C107.101990,847.239868 105.884369,846.000183 105.849358,843.091187   C105.446472,809.620483 104.354752,776.166931 105.432617,742.671997   C106.096451,722.043640 105.990730,701.368408 105.218285,680.705688   C104.620316,664.710083 106.542313,648.802185 109.764961,633.162170   C116.737885,599.321289 130.452713,568.311035 152.975693,542.056152   C175.875153,515.362488 202.307388,492.634583 233.688217,475.883301   C264.074310,459.662994 295.882874,446.979340 328.143707,435.214783   C376.513489,417.575684 426.007141,403.403320 474.903687,387.392395   C493.422333,381.328522 511.901825,374.955658 527.798889,363.075562   C532.368530,359.660645 536.498718,355.814514 539.756897,351.107208   C546.553406,341.287903 546.706726,331.213867 540.076843,321.258179   C532.425598,309.768829 521.280212,302.440460 509.246948,296.490509   C486.720093,285.351898 462.501984,280.208252 437.727905,277.316925   C392.217072,272.005585 346.529175,274.728760 300.911438,274.460205   C284.735962,274.364960 268.600189,273.861053 252.526550,272.141541   C245.555435,271.395782 238.746002,269.513458 232.472641,266.311951   C218.978256,259.425323 215.631668,246.045593 224.190140,233.608856   C232.011169,222.243713 243.039505,214.360031 254.221985,206.796738   C280.797241,188.822571 309.297882,174.308228 338.303070,160.742889   C365.780365,147.892105 393.737946,136.152069 422.307281,125.989258   C441.278015,119.240906 460.346863,112.447472 479.849609,107.594193   C506.309570,101.009605 533.178406,96.014503 559.961060,90.795326   C586.426086,85.638039 613.191711,82.369835 639.930542,78.941505   C671.452881,74.899879 703.095764,72.637573 734.786072,70.325966   C783.741821,66.754944 832.686218,68.517899 881.633789,67.928116   C885.632080,67.879944 889.630371,67.826706 893.628174,67.750381   C900.078857,67.627228 903.322266,70.539955 903.382202,76.964180   C903.467712,86.129143 903.289185,95.296204 903.289001,104.462372   C903.284180,343.292328 903.287048,582.122253 903.295288,820.952209   C903.295471,826.450317 903.451294,831.949280 903.395935,837.446411   C903.316528,845.333862 900.267883,848.327759 892.490662,848.331482   C882.157471,848.336487 871.824341,848.318604 861.491150,848.318665   C731.494080,848.319702 601.497009,848.322021 470.999939,848.324341  M478.179779,216.117050   C495.871826,218.094391 513.579590,219.941238 531.252441,222.077866   C562.349915,225.837524 593.098389,231.620636 623.562134,238.850647   C654.985352,246.308365 686.558167,253.270554 716.888428,264.694000   C732.232117,270.472961 746.932556,277.441040 760.025208,287.506409   C765.364990,291.611603 769.972778,296.384705 773.941284,301.768585   C785.895325,317.985901 784.978088,333.149200 771.084717,347.680878   C757.553162,361.834198 740.455322,370.507874 722.912598,378.357727   C699.617432,388.781738 675.443298,396.873901 651.176758,404.662262   C622.171570,413.971436 593.453918,424.204102 563.775940,431.349030   C521.206543,441.597473 478.800293,452.562256 436.730621,464.646820   C384.666901,479.602173 333.982391,498.535431 284.382019,520.427734   C257.322906,532.370911 230.910629,545.316589 206.916214,562.720703   C185.550491,578.218079 166.791000,596.126465 154.217117,619.877075   C134.910599,656.344971 123.710121,695.194092 121.762840,736.254822   C120.311821,766.851013 121.267426,797.560425 121.087158,828.219055   C121.066895,831.666992 122.038261,833.209290 125.929245,833.323303   C150.084747,834.031677 174.229492,833.101135 198.378357,833.128540   C386.372650,833.341858 574.367615,832.589905 762.361511,833.540955   C775.022034,833.604980 787.697876,832.855896 800.343323,833.243652   C827.498840,834.076294 854.651733,832.998047 881.799866,833.594299   C885.880249,833.683899 888.135864,832.429504 887.809509,827.909241   C887.618408,825.262939 887.968628,822.581970 887.969055,819.916626   C887.992432,686.252258 888.049011,552.587952 888.003601,418.923584   C887.966248,309.092896 887.798645,199.262253 887.735107,89.431572   C887.733032,85.794800 887.799377,83.103218 882.681946,83.138985   C843.041565,83.416039 803.412720,83.019592 763.807800,85.955597   C737.248596,87.924500 710.609680,88.913368 684.178833,92.346199   C665.043884,94.831436 645.704224,96.046173 626.815186,100.089737   C586.386902,108.744133 546.624268,119.820915 508.003021,134.706879   C479.355652,145.748550 451.511200,158.488052 425.415436,174.804459   C421.996918,176.941895 418.887024,179.441101 416.664032,182.874741   C412.092865,189.935394 413.513977,199.019791 420.161316,203.276917   C423.933105,205.692459 428.014282,207.924683 432.483826,208.596634   C447.457214,210.847733 462.155151,214.778076 478.179779,216.117050  z "
            fill="#1a1a1a"
            mask="url(#fillMask)"
          />

          {/* Outline (drawn first) */}
          <path
            ref={outlineRef}
            d="M470.999939,848.324341   C359.668121,848.321960 248.836304,848.344116 138.004547,848.271423   C128.692078,848.265320 119.381805,847.552917 110.066765,847.315491   C107.101990,847.239868 105.884369,846.000183 105.849358,843.091187   C105.446472,809.620483 104.354752,776.166931 105.432617,742.671997   C106.096451,722.043640 105.990730,701.368408 105.218285,680.705688   C104.620316,664.710083 106.542313,648.802185 109.764961,633.162170   C116.737885,599.321289 130.452713,568.311035 152.975693,542.056152   C175.875153,515.362488 202.307388,492.634583 233.688217,475.883301   C264.074310,459.662994 295.882874,446.979340 328.143707,435.214783   C376.513489,417.575684 426.007141,403.403320 474.903687,387.392395   C493.422333,381.328522 511.901825,374.955658 527.798889,363.075562   C532.368530,359.660645 536.498718,355.814514 539.756897,351.107208   C546.553406,341.287903 546.706726,331.213867 540.076843,321.258179   C532.425598,309.768829 521.280212,302.440460 509.246948,296.490509   C486.720093,285.351898 462.501984,280.208252 437.727905,277.316925   C392.217072,272.005585 346.529175,274.728760 300.911438,274.460205   C284.735962,274.364960 268.600189,273.861053 252.526550,272.141541   C245.555435,271.395782 238.746002,269.513458 232.472641,266.311951   C218.978256,259.425323 215.631668,246.045593 224.190140,233.608856   C232.011169,222.243713 243.039505,214.360031 254.221985,206.796738   C280.797241,188.822571 309.297882,174.308228 338.303070,160.742889   C365.780365,147.892105 393.737946,136.152069 422.307281,125.989258   C441.278015,119.240906 460.346863,112.447472 479.849609,107.594193   C506.309570,101.009605 533.178406,96.014503 559.961060,90.795326   C586.426086,85.638039 613.191711,82.369835 639.930542,78.941505   C671.452881,74.899879 703.095764,72.637573 734.786072,70.325966   C783.741821,66.754944 832.686218,68.517899 881.633789,67.928116   C885.632080,67.879944 889.630371,67.826706 893.628174,67.750381   C900.078857,67.627228 903.322266,70.539955 903.382202,76.964180   C903.467712,86.129143 903.289185,95.296204 903.289001,104.462372   C903.284180,343.292328 903.287048,582.122253 903.295288,820.952209   C903.295471,826.450317 903.451294,831.949280 903.395935,837.446411   C903.316528,845.333862 900.267883,848.327759 892.490662,848.331482   C882.157471,848.336487 871.824341,848.318604 861.491150,848.318665   C731.494080,848.319702 601.497009,848.322021 470.999939,848.324341  M478.179779,216.117050   C495.871826,218.094391 513.579590,219.941238 531.252441,222.077866   C562.349915,225.837524 593.098389,231.620636 623.562134,238.850647   C654.985352,246.308365 686.558167,253.270554 716.888428,264.694000   C732.232117,270.472961 746.932556,277.441040 760.025208,287.506409   C765.364990,291.611603 769.972778,296.384705 773.941284,301.768585   C785.895325,317.985901 784.978088,333.149200 771.084717,347.680878   C757.553162,361.834198 740.455322,370.507874 722.912598,378.357727   C699.617432,388.781738 675.443298,396.873901 651.176758,404.662262   C622.171570,413.971436 593.453918,424.204102 563.775940,431.349030   C521.206543,441.597473 478.800293,452.562256 436.730621,464.646820   C384.666901,479.602173 333.982391,498.535431 284.382019,520.427734   C257.322906,532.370911 230.910629,545.316589 206.916214,562.720703   C185.550491,578.218079 166.791000,596.126465 154.217117,619.877075   C134.910599,656.344971 123.710121,695.194092 121.762840,736.254822   C120.311821,766.851013 121.267426,797.560425 121.087158,828.219055   C121.066895,831.666992 122.038261,833.209290 125.929245,833.323303   C150.084747,834.031677 174.229492,833.101135 198.378357,833.128540   C386.372650,833.341858 574.367615,832.589905 762.361511,833.540955   C775.022034,833.604980 787.697876,832.855896 800.343323,833.243652   C827.498840,834.076294 854.651733,832.998047 881.799866,833.594299   C885.880249,833.683899 888.135864,832.429504 887.809509,827.909241   C887.618408,825.262939 887.968628,822.581970 887.969055,819.916626   C887.992432,686.252258 888.049011,552.587952 888.003601,418.923584   C887.966248,309.092896 887.798645,199.262253 887.735107,89.431572   C887.733032,85.794800 887.799377,83.103218 882.681946,83.138985   C843.041565,83.416039 803.412720,83.019592 763.807800,85.955597   C737.248596,87.924500 710.609680,88.913368 684.178833,92.346199   C665.043884,94.831436 645.704224,96.046173 626.815186,100.089737   C586.386902,108.744133 546.624268,119.820915 508.003021,134.706879   C479.355652,145.748550 451.511200,158.488052 425.415436,174.804459   C421.996918,176.941895 418.887024,179.441101 416.664032,182.874741   C412.092865,189.935394 413.513977,199.019791 420.161316,203.276917   C423.933105,205.692459 428.014282,207.924683 432.483826,208.596634   C447.457214,210.847733 462.155151,214.778076 478.179779,216.117050  z "
            fill="none"
            stroke="#1a1a1a"
            strokeWidth="1.2"
          />
        </svg>
      </div>

      {/* Studio Name - Editorial Typography */}
      <div
        ref={textRef}
        style={{
          marginTop: '24px',
          fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
          fontSize: '13px',
          fontWeight: 300,
          letterSpacing: '0.3em',
          color: '#1a1a1a',
          textTransform: 'uppercase',
          position: 'relative',
          textAlign: 'center',
        }}
      >
        STUDIO S<span style={{ color: '#DC2626' }}>â€¢</span>PATH
      </div>
    </div>
  );
};

// Utility functions for localStorage management
export const getTodayDateString = () => {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

export const hasSeenIntroToday = () => {
  if (typeof window === 'undefined') return true;
  const lastSeen = localStorage.getItem(STORAGE_KEY);
  const today = getTodayDateString();
  return lastSeen === today;
};

export const markAsSeenToday = () => {
  if (typeof window === 'undefined') return;
  const today = getTodayDateString();
  localStorage.setItem(STORAGE_KEY, today);
};

export default IntroGateNew;